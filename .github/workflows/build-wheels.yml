name: Build Distribution

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: python -m pip install --upgrade pip build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build_wheels_test:
    name: Build wheels test (full flags)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libnetcdf-dev \
            llvm-17-dev clang-17 lld-17 libclang-17-dev libomp-17-dev

      - name: Build Enzyme from source (Ubuntu)
        run: |
          git clone --depth 1 --recurse-submodules https://github.com/EnzymeAD/Enzyme.git
          ENZYME_SRC="Enzyme"
          if [ ! -f "$ENZYME_SRC/CMakeLists.txt" ]; then
            if [ -f "Enzyme/enzyme/CMakeLists.txt" ]; then
              ENZYME_SRC="Enzyme/enzyme"
            elif [ -f "Enzyme/Enzyme/CMakeLists.txt" ]; then
              ENZYME_SRC="Enzyme/Enzyme"
            else
              echo "Enzyme CMakeLists.txt not found" >&2
              exit 1
            fi
          fi
          LLVM_CONFIG=llvm-config-17
          cmake -S "$ENZYME_SRC" -B Enzyme/build -DLLVM_DIR="$($LLVM_CONFIG --cmakedir)"
          cmake --build Enzyme/build
          ENZYME_PLUGIN=$(find Enzyme/build -name "ClangEnzyme*.so" -o -name "ClangEnzyme*.dylib" | head -n 1)
          if [ -z "$ENZYME_PLUGIN" ]; then
            echo "Enzyme plugin not found in build output" >&2
            exit 1
          fi
          echo "ENZYME_PLUGIN=$ENZYME_PLUGIN" >> $GITHUB_ENV
          echo "CC=clang-17" >> $GITHUB_ENV
          echo "CXX=clang++-17" >> $GITHUB_ENV

      - name: Build SUNDIALS from source (Ubuntu)
        run: |
          git clone --depth 1 https://github.com/LLNL/sundials.git
          cmake -S sundials -B sundials/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$PWD/sundials-install" \
            -DBUILD_SHARED_LIBS=ON \
            -DEXAMPLES_ENABLE=OFF \
            -DUNIT_TEST_ENABLE=OFF \
            -DBUILD_CVODES=ON \
            -DBUILD_ARKODE=OFF \
            -DBUILD_IDA=OFF \
            -DBUILD_IDAS=OFF \
            -DBUILD_KINSOL=OFF
          cmake --build sundials/build
          cmake --build sundials/build --target install
          echo "SUNDIALS_ROOT=$PWD/sundials-install" >> $GITHUB_ENV

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy pytest

      - name: Editable install (pip -e) first
        run: |
          CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5" pip install -e .
          python -c "import droute; print(f'Editable install OK: {droute.__version__}')"

      - name: Full CMake build (all flags)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DDMC_ENABLE_AD=ON \
            -DDMC_ENABLE_ENZYME=ON \
            -DDMC_ENABLE_NETCDF=ON \
            -DDMC_BUILD_TESTS=ON \
            -DDMC_BUILD_PYTHON=ON \
            -DDMC_BUILD_SHARED=ON \
            -DDMC_ENABLE_OPENMP=ON \
            -DDMC_ENABLE_SUNDIALS=ON \
            -DSUNDIALS_ROOT="${SUNDIALS_ROOT}" \
            -DENZYME_PLUGIN="${ENZYME_PLUGIN}"
          cmake --build build

      - name: Run C++ tests
        run: |
          cd build
          ctest --output-on-failure
